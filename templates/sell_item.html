{% extends 'base.html' %}
{% block title %}Продажа товара{% endblock %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <h4 class="card-title mb-3"><i class="fa-solid fa-scale-balanced me-2 text-warning"></i>Продажа товара</h4>

    <form method="post" action="{{ url_for('sell_item_route') }}" enctype="multipart/form-data" id="sellForm" class="row g-3">
      <div class="col-md-8">
        <input type="file" class="form-control" id="image" name="image" accept="image/*" required onchange="previewImageSell()">
      </div>
      <div class="col-md-4 d-flex align-items-center">
        <button type="button" id="startCameraSell" class="btn btn-outline-secondary btn-sm me-2">
          <i class="fa-solid fa-camera"></i>
        </button>
        <button type="button" id="takePhotoSell" class="btn btn-outline-secondary btn-sm me-2 d-none">
          <i class="fa-solid fa-camera-retro"></i>
        </button>
        <button type="submit" class="btn btn-primary" id="findButton">
          <i class="fa-solid fa-magnifying-glass me-1"></i> Найти товар
        </button>
      </div>

      <div class="col-12">
        <video id="videoSell" width="320" height="240" autoplay class="d-none rounded shadow-sm"></video>
        <canvas id="canvasSell" width="320" height="240" class="d-none"></canvas>
        <img id="image-preview" src="#" class="img-fluid d-none rounded shadow-sm" style="max-height:300px;">
      </div>
    </form>

    {% if best_match and show_confirm %}
    <hr>
    <div class="row g-3">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="small text-muted">Найденный товар</h6>
            <img src="{{ url_for('serve_image', filename=best_match.filename) }}" class="img-fluid rounded" style="max-height:320px;">
            <p class="mt-2 mb-0"><strong>{{ best_match.name }}</strong></p>
            <p class="small text-muted">В наличии: {{ best_match.quantity }}</p>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="small text-muted">Ваше фото</h6>
            <img src="data:image/jpeg;base64,{{ sale_image_base64 }}" class="img-fluid rounded" style="max-height:320px;">
            <p class="mt-2">Схожесть: <strong>{{ similarity | round(2) }}</strong></p>

            <div class="d-flex justify-content-center gap-2 mt-3">
              <form method="post" action="{{ url_for('sell_item_route') }}" id="confirmMatchForm">
                <input type="hidden" name="action" value="confirm_match">
                <input type="hidden" name="item_id" value="{{ best_match.id }}">
                <button type="submit" class="btn btn-success" id="confirmMatchButton">Да, это он</button>
              </form>

              <form method="post" action="{{ url_for('sell_item_route') }}" id="rejectMatchForm">
                <input type="hidden" name="action" value="reject_match">
                <button type="submit" class="btn btn-outline-danger" id="rejectMatchButton">Нет</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if alt_matches %}
    <hr>
    <h5>Альтернативы</h5>
    <div class="row">
      {% for match, score in alt_matches %}
      <div class="col-md-4 mb-3">
        <div class="card h-100">
          <img src="{{ url_for('serve_image', filename=match.filename) }}" class="card-img-top" style="height:180px; object-fit:cover;">
          <div class="card-body">
            <h6 class="card-title">{{ match.name }}</h6>
            <p class="small text-muted">Схожесть: {{ score|round(2) }}</p>
            <form method="post" id="selectMatchForm_{{ match.id }}">
              <input type="hidden" name="action" value="confirm_match">
              <input type="hidden" name="item_id" value="{{ match.id }}">
              <button type="submit" class="btn btn-primary btn-sm" id="selectButton_{{ match.id }}">Выбрать</button>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="d-flex gap-2">
      {% if page_2 %}
      <form method="post" id="prevPageForm">
        <input type="hidden" name="action" value="prev_page">
        <button type="submit" class="btn btn-outline-secondary btn-sm" id="prevPageButton">Назад</button>
      </form>
      {% endif %}
      {% if has_more %}
      <form method="post" id="nextPageForm">
        <input type="hidden" name="action" value="next_page">
        <button type="submit" class="btn btn-outline-secondary btn-sm" id="nextPageButton">Дальше</button>
      </form>
      {% endif %}
    </div>
    {% endif %}

    {% if best_match and show_sale_form %}
    <hr>
    <h5>Подтвердить продажу</h5>
    <div class="row g-3">
      <div class="col-md-6">
        <img src="data:image/jpeg;base64,{{ sale_image_base64 }}" class="img-fluid rounded" style="max-height:300px;">
      </div>
      <div class="col-md-6">
        <p>Товар: <strong>{{ best_match.name }}</strong></p>
        <p>В наличии: <strong>{{ best_match.quantity }}</strong></p>
        <form method="post" action="{{ url_for('confirm_sale', item_id=best_match.id) }}" id="confirmSaleForm">
          <div class="mb-3">
            <label class="form-label">Количество для продажи</label>
            <input type="number" name="quantity_sold" class="form-control" min="1" max="{{ best_match.quantity }}" value="1" required>
          </div>
          <button type="submit" class="btn btn-success" id="confirmButton"><i class="fa-solid fa-check me-1"></i> Подтвердить</button>
        </form>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
let streamSell;
const videoSell = document.getElementById('videoSell');
const canvasSell = document.getElementById('canvasSell');
const startCameraSell = document.getElementById('startCameraSell');
const takePhotoSell = document.getElementById('takePhotoSell');
const imageInputSell = document.getElementById('image');

startCameraSell.addEventListener('click', async () => {
    try {
        streamSell = await navigator.mediaDevices.getUserMedia({ video: true });
        videoSell.srcObject = streamSell;
        videoSell.classList.remove('d-none');
        takePhotoSell.classList.remove('d-none');
    } catch (err) {
        console.error('Ошибка доступа к камере:', err);
        alert('Не удалось получить доступ к камере: ' + err.message);
    }
});

takePhotoSell.addEventListener('click', () => {
    const context = canvasSell.getContext('2d');
    context.drawImage(videoSell, 0, 0, 320, 240);
    canvasSell.toBlob((blob) => {
        const file = new File([blob], 'capture.jpg', { type: 'image/jpeg' });
        const dt = new DataTransfer();
        dt.items.add(file);
        imageInputSell.files = dt.files;

        // Show preview
        const imageURL = URL.createObjectURL(blob);
        const preview = document.getElementById('image-preview');
        preview.src = imageURL;
        preview.classList.remove('d-none');

        // Stop camera
        if (streamSell) {
            streamSell.getTracks().forEach(track => track.stop());
            streamSell = null;
        }
        videoSell.classList.add('d-none');
        takePhotoSell.classList.add('d-none');
    }, 'image/jpeg');
});

function previewImageSell() {
    const preview = document.getElementById('image-preview');
    const file = document.getElementById('image').files[0];
    if (!file) {
        preview.classList.add('d-none');
        return;
    }
    const reader = new FileReader();
    reader.onloadend = () => {
        preview.src = reader.result;
        preview.classList.remove('d-none');
    };
    reader.readAsDataURL(file);
}

// Disable buttons on form submission
document.getElementById('sellForm')?.addEventListener('submit', function() {
    document.getElementById('findButton').disabled = true;
});

document.getElementById('confirmSaleForm')?.addEventListener('submit', function() {
    document.getElementById('confirmButton').disabled = true;
});

document.getElementById('confirmMatchForm')?.addEventListener('submit', function() {
    document.getElementById('confirmMatchButton').disabled = true;
});

document.getElementById('rejectMatchForm')?.addEventListener('submit', function() {
    document.getElementById('rejectMatchButton').disabled = true;
});

document.getElementById('nextPageForm')?.addEventListener('submit', function() {
    document.getElementById('nextPageButton').disabled = true;
});

document.getElementById('prevPageForm')?.addEventListener('submit', function() {
    document.getElementById('prevPageButton').disabled = true;
});

document.querySelectorAll('[id^="selectMatchForm_"]').forEach(form => {
    form.addEventListener('submit', function() {
        const button = this.querySelector('button[id^="selectButton_"]');
        if (button) button.disabled = true;
    });
});
</script>
{% endblock %}