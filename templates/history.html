{% extends 'base.html' %}
{% block title %}История продаж{% endblock %}
{% block content %}



<div id="Sales-container">
    <h1>История продаж</h1>
    <p>Общая прибыль: {{ total_profit }}</p>
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table" id="salesTable">
                    <thead>
                        <tr>
                            <th data-sort="text">Товар <i class="fa-solid fa-sort"></i></th>
                            <th data-sort="num">Количество <i class="fa-solid fa-sort"></i></th>
                            <th data-sort="num">Цена <i class="fa-solid fa-sort"></i></th>
                            <th data-sort="num">Прибыль <i class="fa-solid fa-sort"></i></th>
                            <th data-sort="text">Дата <i class="fa-solid fa-sort"></i></th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="salesTbody">
                        {% for sale in sales_history %}
                        <tr>
                            <td>{{ sale.name }}</td>
                            <td>{{ sale.quantity_sold }}</td>
                            <td>{{ sale.retail_price }}</td>
                            <td>{{ sale.profit }}</td>
                            <td>{{ sale.timestamp }}</td>
                            <td>
                                <a href="{{ url_for('edit_sale', sale_id=sale.id) }}" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-pen"></i></a>
                                <a href="{{ url_for('delete_sale', sale_id=sale.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Удалить товар?')"><i class="fa-solid fa-trash"></i></a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

>>>>>>> Stashed changes
<button class="btn btn-outline-primary btn-sm" id="sortByPhotoBtn">
    <i class="fa-solid fa-camera"></i> Сортировать по фото
</button>

<div id="inventory-container">
    <h5>Текущий склад</h5>
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped align-middle" id="itemsTable">
                    <thead id="itemsThead">
                        <tr>
                            <th><i class="fa-solid fa-camera"></i> Фото</th>
                            <th data-sort="text">Название <i class="fa-solid fa-sort"></i></th>
                            <th data-sort="num">Кол-во <i class="fa-solid fa-sort"></i></th>
                            <th data-sort="num">Опт <i class="fa-solid fa-sort"></i></th>
                            <th data-sort="num">Розница <i class="fa-solid fa-sort"></i></th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTbody">
                        {% for item in database %}
                        <tr data-id="{{ item.id }}">
                            <td><img src="{{ url_for('serve_image', filename=item.filename) }}" style="height:48px; object-fit:cover;" class="rounded"></td>
                            <td class="item-name">{{ item.name }}</td>
                            <td class="item-qty">{{ item.quantity }}</td>
                            <td class="item-wholesale">{{ item.wholesale_price }}</td>
                            <td class="item-retail">{{ item.retail_price }}</td>
                            <td>
                                <a href="{{ url_for('edit_item', item_id=item.id) }}" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-pen"></i></a>
                                <a href="{{ url_for('delete_item', item_id=item.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Удалить товар?')"><i class="fa-solid fa-trash"></i></a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Сделать фото или загрузить</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex gap-2 mb-3">
                    <button id="switchCamBtn" class="btn btn-outline-secondary btn-sm">Переключить камеру</button>
                    <input type="file" id="uploadPhoto" accept="image/*" class="form-control form-control-sm" />
                </div>
                <div class="d-flex gap-3">
                    <div>
                        <video id="modalVideo" autoplay playsinline style="max-width:420px; border-radius:8px; background:#000;"></video>
                        <div class="mt-2">
                            <button id="takePhoto" class="btn btn-primary btn-sm mt-2">Сделать фото</button>
                        </div>
                    </div>
                    <div>
                        <canvas id="modalCanvas" width="420" height="315" style="display:none;"></canvas>
                        <img id="modalPreview" src="#" class="img-fluid d-none rounded shadow-sm" style="max-height:300px;">
                    </div>
                </div>
                <div class="mt-3">
                    <button id="submitSort" class="btn btn-success">Отправить и отсортировать</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    th[data-sort] {
        cursor: pointer;
        user-select: none;
    }
    th[data-sort]:hover {
        background-color: #f1f3f5;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    function bindSortEventListeners() {
        document.querySelectorAll('#salesTable thead th[data-sort]').forEach(th => {
            const icon = th.querySelector('i');
            th.addEventListener('click', () => {
                const type = th.dataset.sort;
                const index = Array.from(th.parentNode.children).indexOf(th);
                const tbody = document.querySelector('#salesTbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const asc = !th.classList.contains('asc');

                rows.sort((a, b) => {
                    let aText = a.children[index].textContent.trim();
                    let bText = b.children[index].textContent.trim();
                    if (type === 'num') {
                        return asc ? parseFloat(aText) - parseFloat(bText) : parseFloat(bText) - parseFloat(aText);
                    } else {
                        return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
                    }
                });

                tbody.innerHTML = '';
                rows.forEach(r => tbody.appendChild(r));

                document.querySelectorAll('#salesTable thead th').forEach(h => {
                    h.classList.remove('asc', 'desc');
                    const i = h.querySelector('i');
                    if (i) i.className = 'fa-solid fa-sort';
                });

                th.classList.add(asc ? 'asc' : 'desc');
                icon.className = asc ? 'fa-solid fa-sort-up' : 'fa-solid fa-sort-down';
            });
        });
    }

    bindSortEventListeners();
});
    let stream = null;
    let usingFacing = 'environment';
    const video = document.getElementById('modalVideo');
    const canvas = document.getElementById('modalCanvas');
    const preview = document.getElementById('modalPreview');
    let originalTheadHtml = '';

    document.addEventListener('DOMContentLoaded', () => {
        // Сохраняем оригинальный HTML-код заголовка таблицы
        originalTheadHtml = document.getElementById('itemsThead').innerHTML;
        // Привязываем обработчики событий при загрузке страницы
        bindSortEventListeners();
    });

    // ---------- CAMERA ----------
    async function startStream() {
        if (stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
        }
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: usingFacing }, audio: false });
            video.srcObject = stream;
        } catch (e) {
            console.error(e);
            alert('Не удалось получить доступ к камере: ' + e.message);
        }
    }

    document.getElementById('sortByPhotoBtn').addEventListener('click', () => {
        preview.classList.add('d-none');
        document.getElementById('uploadPhoto').value = '';
        var modal = new bootstrap.Modal(document.getElementById('photoModal'));
        modal.show();
        startStream();
    });

    document.getElementById('switchCamBtn').addEventListener('click', () => {
        usingFacing = usingFacing === 'environment' ? 'user' : 'environment';
        startStream();
    });

    document.getElementById('takePhoto').addEventListener('click', () => {
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob((b) => {
            const url = URL.createObjectURL(b);
            preview.src = url;
            preview.classList.remove('d-none');
            preview._blob = b;
        }, 'image/jpeg', 0.9);
    });

    document.getElementById('uploadPhoto').addEventListener('change', (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const url = URL.createObjectURL(f);
        preview.src = url;
        preview.classList.remove('d-none');
        preview._blob = f;
    });

    document.getElementById('submitSort').addEventListener('click', async () => {
        const b = preview._blob;
        if (!b) {
            alert('Сначала сделайте фото или загрузите файл.');
            return;
        }
        const fd = new FormData();
        fd.append('image', b, 'photo.jpg');
        document.getElementById('submitSort').disabled = true;
        document.getElementById('submitSort').innerText = 'Отправка...';

        const resp = await fetch('/sort_by_image', { method: 'POST', body: fd });
        const data = await resp.json();
        document.getElementById('submitSort').disabled = false;
        document.getElementById('submitSort').innerText = 'Отправить и отсортировать';

        if (data.error) {
            alert(data.error);
            return;
        }

        updateTable(data.results);
        bootstrap.Modal.getInstance(document.getElementById('photoModal')).hide();
        if (stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
        }
    });

    // ---------- CLIENT SORT ----------
    function bindSortEventListeners() {
        document.querySelectorAll('#itemsTable thead th[data-sort]').forEach(th => {
            const icon = th.querySelector('i');
            th.addEventListener('click', () => {
                const type = th.dataset.sort;
                const index = Array.from(th.parentNode.children).indexOf(th);
                const tbody = document.querySelector('#itemsTbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const asc = !th.classList.contains('asc');

                rows.sort((a, b) => {
                    let aText = a.children[index].textContent.trim();
                    let bText = b.children[index].textContent.trim();
                    if (type === 'num') {
                        return asc ? parseFloat(aText) - parseFloat(bText) : parseFloat(bText) - parseFloat(aText);
                    } else {
                        return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
                    }
                });

                tbody.innerHTML = '';
                rows.forEach(r => tbody.appendChild(r));

                document.querySelectorAll('#itemsTable thead th').forEach(h => {
                    h.classList.remove('asc', 'desc');
                    const i = h.querySelector('i');
                    if (i) i.className = 'fa-solid fa-sort';
                });

                th.classList.add(asc ? 'asc' : 'desc');
                icon.className = asc ? 'fa-solid fa-sort-up' : 'fa-solid fa-sort-down';
            });
        });
    }

    function updateTable(items) {
        const tbody = document.getElementById('itemsTbody');
        tbody.innerHTML = '';
        for (const it of items) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><img src="/images/${it.filename}" style="height:48px; object-fit:cover;" class="rounded"></td>
                <td>${it.score}</td>
                <td class="item-name">${it.name}</td>
                <td class="item-qty">${it.quantity}</td>
                <td class="item-wholesale">${it.wholesale_price}</td>
                <td class="item-retail">${it.retail_price}</td>
                <td>
                    <a href="/edit_item/${it.id}" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-pen"></i></a>
                    <a href="/delete_item/${it.id}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Удалить товар?')"><i class="fa-solid fa-trash"></i></a>
                </td>
            `;
            tbody.appendChild(tr);
        }
        const thead = document.getElementById('itemsThead');
        thead.innerHTML = `
            <tr>
                <th><i class="fa-solid fa-camera"></i> Фото</th>
                <th data-sort="num">Схожесть <i class="fa-solid fa-sort"></i></th>
                <th data-sort="text">Название <i class="fa-solid fa-sort"></i></th>
                <th data-sort="num">Кол-во <i class="fa-solid fa-sort"></i></th>
                <th data-sort="num">Опт <i class="fa-solid fa-sort"></i></th>
                <th data-sort="num">Розница <i class="fa-solid fa-sort"></i></th>
                <th>Действия</th>
            </tr>
        `;
        // После перезаписи thead, заново привязываем обработчики событий
        bindSortEventListeners();
    }
    document.addEventListener('DOMContentLoaded', function() {
    function bindSortEventListeners() {
        document.querySelectorAll('#salesTable thead th[data-sort]').forEach(th => {
            const icon = th.querySelector('i');
            th.addEventListener('click', () => {
                const type = th.dataset.sort;
                const index = Array.from(th.parentNode.children).indexOf(th);
                const tbody = document.querySelector('#salesTbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const asc = !th.classList.contains('asc');

                rows.sort((a, b) => {
                    let aText = a.children[index].textContent.trim();
                    let bText = b.children[index].textContent.trim();
                    if (type === 'num') {
                        return asc ? parseFloat(aText) - parseFloat(bText) : parseFloat(bText) - parseFloat(aText);
                    } else {
                        return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
                    }
                });

                tbody.innerHTML = '';
                rows.forEach(r => tbody.appendChild(r));

                document.querySelectorAll('#salesTable thead th').forEach(h => {
                    h.classList.remove('asc', 'desc');
                    const i = h.querySelector('i');
                    if (i) i.className = 'fa-solid fa-sort';
                });

                th.classList.add(asc ? 'asc' : 'desc');
                icon.className = asc ? 'fa-solid fa-sort-up' : 'fa-solid fa-sort-down';
            });
        });
    }

    bindSortEventListeners();
});
</script>
{% endblock %}

