{% extends 'base.html' %}
{% block title %}Добавить товар{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card shadow-lg fade-in">
      <div class="card-body p-4">
        <h4 class="card-title mb-4 text-center">
          <i class="fa-solid fa-plus-circle text-success me-2"></i>Добавить новый товар
        </h4>

        <form method="post" action="{{ url_for('add_item') }}" enctype="multipart/form-data" id="addForm" class="row g-4">
          <div class="col-md-6">
            <label class="form-label">Название</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-solid fa-tag"></i></span>
              <input name="name" id="name" class="form-control" placeholder="Введите название товара" required>
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Количество</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-solid fa-hashtag"></i></span>
              <input type="number" name="quantity" id="quantity" class="form-control" placeholder="Введите количество" min="0" required>
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Оптовая цена</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-solid fa-money-bill-wave"></i></span>
              <input type="number" step="0.01" name="wholesale_price" id="wholesale_price" class="form-control" placeholder="Введите оптовую цену" min="0" required>
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Розничная цена</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-solid fa-hand-holding-dollar"></i></span>
              <input type="number" step="0.01" name="retail_price" id="retail_price" class="form-control" placeholder="Введите розничную цену" min="0" required>
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">Фото товара</label>
            <div class="border rounded-3 p-3 bg-light">
              <div class="d-flex flex-column flex-md-row gap-3 align-items-start">
                <div class="flex-grow-1">
                  <input type="file" class="form-control" id="image" name="image" accept="image/*" required onchange="previewImage()">
                  <div class="form-text">Поддерживаемые форматы: JPG, PNG, WEBP (макс. 5MB)</div>
                </div>
                <div id="preview-container">
                  <img id="image-preview" src="#" alt="Превью" class="img-thumbnail d-none" style="max-width:160px; height:120px; object-fit:cover;">
                </div>
              </div>
              
              <div class="mt-3">
                <button type="button" id="startCameraAdd" class="btn btn-outline-secondary btn-sm">
                  <i class="fa-solid fa-camera me-1"></i> Использовать камеру
                </button>
                <button type="button" id="takePhotoAdd" class="btn btn-outline-primary btn-sm d-none">
                  <i class="fa-solid fa-camera-retro me-1"></i> Сделать фото
                </button>
              </div>
            </div>
          </div>

          <div class="col-12">
            <video id="videoAdd" width="100%" height="240" autoplay class="d-none rounded border"></video>
            <canvas id="canvasAdd" width="320" height="240" class="d-none"></canvas>
          </div>

          <div class="col-12 mt-2">
            <div class="d-flex justify-content-between">
              <a href="{{ url_for('history') }}" class="btn btn-outline-secondary">
                <i class="fa-solid fa-arrow-left me-1"></i> Назад
              </a>
              <button type="submit" id="addButton" class="btn btn-success px-4">
                <i class="fa-solid fa-plus me-1"></i> Добавить товар
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
let streamAdd;
const videoAdd = document.getElementById('videoAdd');
const canvasAdd = document.getElementById('canvasAdd');
const startCameraAdd = document.getElementById('startCameraAdd');
const takePhotoAdd = document.getElementById('takePhotoAdd');
const imageInputAdd = document.getElementById('image');

startCameraAdd.addEventListener('click', async () => {
    try {
        streamAdd = await navigator.mediaDevices.getUserMedia({ video: true });
        videoAdd.srcObject = streamAdd;
        videoAdd.classList.remove('d-none');
        takePhotoAdd.classList.remove('d-none');
        startCameraAdd.classList.add('d-none');
    } catch (err) {
        console.error('Ошибка доступа к камере:', err);
        alert('Не удалось получить доступ к камере: ' + err.message);
    }
});

takePhotoAdd.addEventListener('click', () => {
    const context = canvasAdd.getContext('2d');
    context.drawImage(videoAdd, 0, 0, 320, 240);
    canvasAdd.toBlob((blob) => {
        const file = new File([blob], 'capture.jpg', { type: 'image/jpeg' });
        const dt = new DataTransfer();
        dt.items.add(file);
        imageInputAdd.files = dt.files;
        const preview = document.getElementById('image-preview');
        preview.src = URL.createObjectURL(blob);
        preview.classList.remove('d-none');

        // stop camera
        if (streamAdd) streamAdd.getTracks().forEach(t => t.stop());
        videoAdd.classList.add('d-none');
        takePhotoAdd.classList.add('d-none');
        startCameraAdd.classList.remove('d-none');
    }, 'image/jpeg');
});

function previewImage() {
    const preview = document.getElementById('image-preview');
    const file = document.getElementById('image').files[0];
    const reader = new FileReader();
    reader.onloadend = function () {
        preview.src = reader.result;
        preview.classList.remove('d-none');
    };
    if (file) reader.readAsDataURL(file);
}

document.getElementById('addForm').addEventListener('submit', function() {
    const btn = document.getElementById('addButton');
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i> Добавляем...';
});
</script>
{% endblock %}
