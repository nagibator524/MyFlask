{% extends 'base.html' %}
{% block title %}Добавить товар{% endblock %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <h4 class="card-title mb-3"><i class="fa-solid fa-plus me-2 text-success"></i>Добавить новый товар</h4>

    <form method="post" action="{{ url_for('add_item') }}" enctype="multipart/form-data" id="addForm" class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Название</label>
        <input name="name" id="name" class="form-control" required>
      </div>

      <div class="col-md-6">
        <label class="form-label">Количество</label>
        <input type="number" name="quantity" id="quantity" class="form-control" required>
      </div>

      <div class="col-md-6">
        <label class="form-label">Оптовая цена</label>
        <input type="number" step="0.01" name="wholesale_price" id="wholesale_price" class="form-control" required>
      </div>

      <div class="col-md-6">
        <label class="form-label">Розничная цена</label>
        <input type="number" step="0.01" name="retail_price" id="retail_price" class="form-control" required>
      </div>

      <div class="col-12">
        <label class="form-label">Фото</label>
        <div class="d-flex gap-2 align-items-start">
          <input type="file" class="form-control" id="image" name="image" accept="image/*" required onchange="previewImage()">
          <div id="preview-container" class="ms-2" style="min-width:120px;">
            <img id="image-preview" src="#" alt="Превью" class="img-thumbnail d-none" style="max-width:160px;">
          </div>
        </div>
        <div class="mt-2">
          <button type="button" id="startCameraAdd" class="btn btn-outline-secondary btn-sm">
            <i class="fa-solid fa-camera"></i> Камера
          </button>
          <button type="button" id="takePhotoAdd" class="btn btn-outline-secondary btn-sm d-none">
            <i class="fa-solid fa-image"></i> Сделать фото
          </button>
        </div>
      </div>

      <div class="col-12">
        <video id="videoAdd" width="320" height="240" autoplay class="d-none border rounded"></video>
        <canvas id="canvasAdd" width="320" height="240" class="d-none"></canvas>
      </div>

      <div class="col-12 d-flex justify-content-end">
        <button type="submit" id="addButton" class="btn btn-success">
          <i class="fa-solid fa-check me-1"></i> Добавить
        </button>
      </div>
    </form>
  </div>
</div>

<script>
let streamAdd;
const videoAdd = document.getElementById('videoAdd');
const canvasAdd = document.getElementById('canvasAdd');
const startCameraAdd = document.getElementById('startCameraAdd');
const takePhotoAdd = document.getElementById('takePhotoAdd');
const imageInputAdd = document.getElementById('image');

startCameraAdd.addEventListener('click', async () => {
    try {
        streamAdd = await navigator.mediaDevices.getUserMedia({ video: true });
        videoAdd.srcObject = streamAdd;
        videoAdd.classList.remove('d-none');
        takePhotoAdd.classList.remove('d-none');
        startCameraAdd.classList.add('d-none');
    } catch (err) {
        console.error('Ошибка доступа к камере:', err);
        alert('Не удалось получить доступ к камере: ' + err.message);
    }
});

takePhotoAdd.addEventListener('click', () => {
    const context = canvasAdd.getContext('2d');
    context.drawImage(videoAdd, 0, 0, 320, 240);
    canvasAdd.toBlob((blob) => {
        const file = new File([blob], 'capture.jpg', { type: 'image/jpeg' });
        const dt = new DataTransfer();
        dt.items.add(file);
        imageInputAdd.files = dt.files;
        const preview = document.getElementById('image-preview');
        preview.src = URL.createObjectURL(blob);
        preview.classList.remove('d-none');

        // stop camera
        if (streamAdd) streamAdd.getTracks().forEach(t => t.stop());
        videoAdd.classList.add('d-none');
        takePhotoAdd.classList.add('d-none');
        startCameraAdd.classList.remove('d-none');
    }, 'image/jpeg');
});

function previewImage() {
    const preview = document.getElementById('image-preview');
    const file = document.getElementById('image').files[0];
    const reader = new FileReader();
    reader.onloadend = function () {
        preview.src = reader.result;
        preview.classList.remove('d-none');
    };
    if (file) reader.readAsDataURL(file);
}

document.getElementById('addForm').addEventListener('submit', function() {
    const btn = document.getElementById('addButton');
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Делаем...';
});
</script>
{% endblock %}
